---
title: "Yeo-Johnson Transformation Testing"
output:
  html_document:
    self_contained: True
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  digits = 3,
  comment = "#>",
  collapse = TRUE,
  cache = FALSE,
  dev.args = list(bg = "transparent"),
  dpi = 300,
  cache.lazy = FALSE,
  out.width = "90%",
  fig.align = "center",
  fig.width = 9,
  fig.height = 6
)
ggplot2::theme_set(ggplot2::theme_bw())
options(
  dplyr.print_min = 6,
  dplyr.print_max = 6,
  pillar.max_footer_lines = 2,
  pillar.min_chars = 15,
  stringr.view_n = 6,
  pillar.bold = TRUE,
  width = 77
)
suppressPackageStartupMessages(source(here::here("R", "load_all.R")))
```

## Setup and Data Loading

First, we'll set up the environment and load the necessary data:

```{r setup-env}
# Simple case with keys = geo_value.
filtered_data <- cases_deaths_subset %>%
  filter(time_value > "2021-01-01", geo_value %in% c("ca", "ny")) %>%
  select(geo_value, time_value, cases)
```

## Yeo-Johnson Transformation

Let's apply the Yeo-Johnson transformation to our data:

```{r yeo-johnson-transform}
r <- epi_recipe(filtered_data) %>%
  step_epi_YeoJohnson(cases) %>%
  prep(filtered_data)

# Display the recipe
r

# Inspect the lambda values for each state
r$steps[[1]]$lambdas
```

## Manual Whitening Comparison

Now, let's compare the Yeo-Johnson transformation with a manual whitening approach using quarter root scaling:

```{r manual-whitening}
# Apply the transformation
out1 <- r %>% bake(filtered_data)
out2 <- filtered_data %>%
  mutate(cases = (cases + 0.01)^(1 / 4))

filtered_data %>%
  mutate(cases = log(cases)) %>%
  ggplot(aes(time_value, cases)) +
  geom_line(color = "blue") +
  geom_line(data = out1 %>% mutate(cases = log(cases)),
            aes(time_value, cases), color = "green") +
  geom_line(data = out2 %>% mutate(cases = log(cases)),
            aes(time_value, cases), color = "red") +
  facet_wrap(~geo_value, scales = "free_y") +
  theme_minimal() +
  labs(title = "Yeo-Johnson transformation", x = "Time", y = "Log Cases")
```
