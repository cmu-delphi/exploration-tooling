---
title: Evaluation of Hospitalization Forecasters 2024-2025
date: "`r format(Sys.time(), '%d %B %Y')`"
abstract: |
  This notebook is a template for evaluating hospitalization forecasters. It
  relies on the script get_scores.R from the same directory.
output:
  html_document:
    code_folding: hide
params:
  forecaster_set: 1
editor_options:
  chunk_output_type: console
---

$$\\[.4in]$$

```{r echo=FALSE}
# Package installation
knitr::opts_chunk$set(
    fig.align = "center",
    message = FALSE,
    warning = FALSE,
    cache = TRUE
)
```

```{r}
library(aws.s3)
library(data.table)
library(dplyr)
library(DT)
library(ggplot2)
library(plotly)
library(readr)
library(stringr)
library(scoringutils)
library(tidyr)
```

### Forecaster Name To Parameter Mapping

```{r}
s3load("flu_2023_forecaster_parameter_combinations.rds", bucket = "forecasting-team-data")
datatable(forecaster_parameter_combinations_[[params$forecaster_set]])
```

### Retrieving Forecast Data

```{r}
params <- list(
    forecaster_set = 1
)
forecasters <- forecaster_parameter_combinations_[[params$forecaster_set]]$id

# Load forecasts and scores
s3load(object = "flu_2023_joined_scores.rds", bucket = "forecasting-team-data")
flu_2023_joined_scores <- flu_2023_joined_scores %>%
    filter(forecaster %in% forecasters)

forecast_dates <- flu_2023_joined_scores %>%
    pull(forecast_date) %>%
    unique()
forecasters <- flu_2023_joined_scores %>%
    pull(forecaster) %>%
    unique()
aheads <- flu_2023_joined_scores %>%
    pull(ahead) %>%
    unique()

Mean <- function(x) mean(x, na.rm = TRUE)
GeoMean <- function(x, offset = 0) exp(Mean(log(x + offset)))
```

**The target forecast dates are:** <br/> `r forecast_dates`

**The template will compile data of the following forecasters:** <br/> `r forecasters`.

$$\\[.07in]$$

### Weighted Interval Score (relative to baseline) and 80% Coverage {.tabset}

Score all forecasters relative to the COVIDhub-baseline, aggregating across
geos with geometric mean.

#### WIS by Forecast Date

```{r}
base_forecaster_name <- "FluSight-baseline"
var <- "wis"
id_cols <- c("forecaster", "forecast_date", "ahead")

df <- scores %>%
    select(all_of(c(id_cols, var))) %>%
    drop_na(forecast_date, !!sym(var)) %>%
    summarize(!!var := GeoMean(!!sym(var)), .by = all_of(id_cols)) %>%
    # TODO: Filter out negative aheads for now.
    filter(ahead >= 0)

if (df %>% filter(forecaster == base_forecaster_name & near(!!sym(var), 0)) %>% nrow() > 0) {
    warning("scale_by_forecaster will divide by zero in column ", var)
}

normalized_df <- df %>%
    select(all_of(c(id_cols, var))) %>%
    pivot_wider(names_from = forecaster, names_prefix = var, values_from = !!sym(var)) %>%
    mutate(across(starts_with(var), ~ .x / !!sym(paste0(var, base_forecaster_name)))) %>%
    pivot_longer(cols = starts_with(var), names_to = "forecaster", values_to = var) %>%
    mutate(forecaster = stringr::str_remove(forecaster, var)) %>%
    filter(forecaster != base_forecaster_name)

facets.label <- str_glue("{aheads} days ahead")
names(facets.label) <- aheads
subtitle <- sprintf(
    "Forecasts made over %s to %s",
    format(min(forecast_dates), "%B %d, %Y"),
    format(max(forecast_dates), "%B %d, %Y")
)
p <- ggplot(normalized_df, aes(x = forecast_date, y = !!sym(var))) +
    geom_line(aes(color = forecaster, group = forecaster)) +
    geom_point(aes(color = forecaster, group = forecaster)) +
    facet_grid(rows = vars(ahead)) +
    facet_wrap(~ahead, nrow = 4, labeller = labeller(ahead = facets.label)) +
    scale_y_log10() +
    scale_color_viridis_d() +
    guides(color = guide_legend(ncol = 2)) +
    labs(title = subtitle, x = "Forecast Dates", y = "Geometric Mean WIS")

ggplotly(p, tooltip = "text", height = 800, width = 1000) %>%
    layout(hoverlabel = list(bgcolor = "white"))
```

#### WIS by Ahead

```{r}
base_forecaster_name <- "FluSight-baseline"
var <- "wis"
id_cols <- c("forecaster", "ahead")

df <- scores %>%
    select(all_of(c(id_cols, var))) %>%
    drop_na(!!sym(var)) %>%
    summarize(!!var := GeoMean(!!sym(var)), .by = all_of(id_cols)) %>%
    # TODO: Filter out negative aheads for now.
    filter(ahead >= 0)

if (df %>% filter(forecaster == base_forecaster_name & near(!!sym(var), 0)) %>% nrow() > 0) {
    warning("scale_by_forecaster will divide by zero in column ", var)
}

normalized_df <- df %>%
    select(all_of(c(id_cols, var))) %>%
    pivot_wider(names_from = forecaster, names_prefix = var, values_from = !!sym(var)) %>%
    mutate(across(starts_with(var), ~ .x / !!sym(paste0(var, base_forecaster_name)))) %>%
    pivot_longer(cols = starts_with(var), names_to = "forecaster", values_to = var) %>%
    mutate(forecaster = stringr::str_remove(forecaster, var)) %>%
    filter(forecaster != base_forecaster_name)

subtitle <- sprintf(
    "Forecasts made over %s to %s",
    format(min(forecast_dates), "%B %d, %Y"),
    format(max(forecast_dates), "%B %d, %Y")
)
p <- ggplot(normalized_df, aes(x = ahead, y = !!sym(var))) +
    geom_line(aes(color = forecaster, group = forecaster)) +
    geom_point(aes(color = forecaster, group = forecaster)) +
    scale_y_log10() +
    scale_color_viridis_d() +
    guides(color = guide_legend(ncol = 2)) +
    labs(title = subtitle, x = "Days ahead", y = "Geometric Mean WIS")

ggplotly(p, tooltip = "text", height = 800, width = 1000) %>%
    layout(hoverlabel = list(bgcolor = "white"))
```

#### % Coverage by Forecast Date

```{r}
base_forecaster_name <- "FluSight-baseline"
var <- "coverage_80"
id_cols <- c("forecaster", "forecast_date", "ahead")

df <- scores %>%
    select(all_of(c(id_cols, var))) %>%
    drop_na(forecast_date, !!sym(var)) %>%
    summarize(!!var := Mean(!!sym(var)), .by = all_of(id_cols)) %>%
    # TODO: Filter out negative aheads for now.
    filter(ahead >= 0)

if (df %>% filter(forecaster == base_forecaster_name & near(!!sym(var), 0)) %>% nrow() > 0) {
    warning("scale_by_forecaster will divide by zero in column ", var)
}

normalized_df <- df %>%
    select(all_of(c(id_cols, var))) %>%
    pivot_wider(names_from = forecaster, names_prefix = var, values_from = !!sym(var)) %>%
    mutate(across(starts_with(var), ~ .x / !!sym(paste0(var, base_forecaster_name)))) %>%
    pivot_longer(cols = starts_with(var), names_to = "forecaster", values_to = var) %>%
    mutate(forecaster = stringr::str_remove(forecaster, var)) %>%
    filter(forecaster != base_forecaster_name)

facets.label <- str_glue("{aheads} days ahead")
names(facets.label) <- aheads
subtitle <- sprintf(
    "Forecasts made over %s to %s",
    format(min(forecast_dates), "%B %d, %Y"),
    format(max(forecast_dates), "%B %d, %Y")
)
p <- ggplot(normalized_df, aes(x = forecast_date, y = !!sym(var))) +
    geom_line(aes(color = forecaster, group = forecaster)) +
    geom_point(aes(color = forecaster, group = forecaster)) +
    facet_grid(rows = vars(ahead)) +
    facet_wrap(~ahead, nrow = 4, labeller = labeller(ahead = facets.label)) +
    scale_y_log10() +
    scale_color_viridis_d() +
    guides(color = guide_legend(ncol = 2)) +
    labs(title = subtitle, x = "Forecast Dates", y = "Mean 80% Coverage")
p

ggplotly(p, tooltip = "text", height = 800, width = 1000) %>%
    layout(hoverlabel = list(bgcolor = "white"))
```

#### % Coverage by Ahead

```{r}
base_forecaster_name <- "FluSight-baseline"
var <- "coverage_80"
id_cols <- c("forecaster", "ahead")

df <- scores %>%
    select(all_of(c(id_cols, var))) %>%
    drop_na(!!sym(var)) %>%
    summarize(!!var := Mean(!!sym(var)), .by = all_of(id_cols)) %>%
    # TODO: Filter out negative aheads for now.
    filter(ahead >= 0)

if (df %>% filter(forecaster == base_forecaster_name & near(!!sym(var), 0)) %>% nrow() > 0) {
    warning("scale_by_forecaster will divide by zero in column ", var)
}

normalized_df <- df %>%
    select(all_of(c(id_cols, var))) %>%
    pivot_wider(names_from = forecaster, names_prefix = var, values_from = !!sym(var)) %>%
    mutate(across(starts_with(var), ~ .x / !!sym(paste0(var, base_forecaster_name)))) %>%
    pivot_longer(cols = starts_with(var), names_to = "forecaster", values_to = var) %>%
    mutate(forecaster = stringr::str_remove(forecaster, var)) %>%
    filter(forecaster != base_forecaster_name)

subtitle <- sprintf(
    "Forecasts made over %s to %s",
    format(min(forecast_dates), "%B %d, %Y"),
    format(max(forecast_dates), "%B %d, %Y")
)
p <- ggplot(normalized_df, aes(x = ahead, y = !!sym(var))) +
    geom_line(aes(color = forecaster, group = forecaster)) +
    geom_point(aes(color = forecaster, group = forecaster)) +
    scale_y_log10() +
    scale_color_viridis_d() +
    guides(color = guide_legend(ncol = 2)) +
    labs(title = subtitle, x = "Days ahead", y = "Mean 80% Coverage")
p

ggplotly(p, tooltip = "text", height = 800, width = 1000) %>%
    layout(hoverlabel = list(bgcolor = "white"))
```

### Fan plots

```{r}
# TODO: Need to upload the forecast data and then copy the plotting code from the vignette.
# local_forecasts <- tar_df %>%
#     filter(str_detect(name, "forecast_")) %>%
#     pull(name) %>%
#     map(~ tibble(forecaster = str_remove(.x, "forecast_"), tar_read_raw(.x))) %>%
#     bind_rows() %>%
#     # This is a correction for the fact that we forecast on Wednesdays, but labeled
#     # the forecasts as if they were made on the following Saturday.
#     mutate(forecast_date = forecast_date + 3, target_end_date = target_end_date + 3)

s3load(object = "flu_2023_forecasts_scaled_1.rds", bucket = "forecasting-team-data")
flu_2023_forecasts_scaled_1 %>%
    # This is a correction for the fact that we forecast on Wednesdays, but labeled
    # the forecasts as if they were made on the following Saturday.
    mutate(forecast_date = forecast_date + 3, target_end_date = target_end_date + 3)

# TODO: Merge with FluSight forecasts.
# TODO: Subselect.
geo_vals <- c("ca", "fl", "pa", "tx")
forecast_subset <- flu_2023_forecasts_scaled_1 %>%
    filter(model == "forecast_ridiculous.mollies", geo_value %in% geo_vals) %>%
    pivot_wider(names_from = quantile, values_from = prediction)
true_data <- tar_read(hhs_evaluation_data) %>% filter(geo_value %in% geo_vals)

# TODO: Fan plots.
ggplot(data = forecast_subset, aes(x = target_end_date, group = forecast_date)) +
    geom_ribbon(aes(ymin = `0.05`, ymax = `0.95`, fill = factor(forecast_date)), alpha = 0.4) +
    geom_line(aes(y = `0.5`, color = factor(forecast_date)), linetype = 2L) +
    geom_point(aes(y = `0.5`, color = factor(forecast_date)), size = 0.75) +
    geom_line(
        data = true_data,
        aes(x = target_end_date, y = true_value),
        inherit.aes = FALSE, na.rm = TRUE
    ) +
    facet_wrap(~geo_value) +
    # scale_x_date(minor_breaks = "month", date_labels = "%b %y") +
    # scale_y_continuous(expand = expansion(c(0, 0.05)))
    labs(x = "Reference Date", y = "Forecasts") +
    theme(legend.position = "none")
```
